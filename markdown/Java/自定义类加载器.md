**<font color='red'>ã€ŒJVM ç±»åŠ è½½å­ç³»ç»Ÿã€ç³»åˆ—æ–‡ç« </font>**

- **[ç±»åŠ è½½çš„è¿‡ç¨‹](./ç±»åŠ è½½çš„è¿‡ç¨‹.html)**
- **[ç±»åŠ è½½çš„æ—¶æœº](./ç±»åŠ è½½çš„æ—¶æœº.html)**
- **[ç±»åŠ è½½å™¨](./ç±»åŠ è½½å™¨.html)**
- **[å‰–æ [Bootstrapã€Extensionã€Application] ClassLoader](./å‰–æ-Bootstrap-Extension-Application-ClassLoader.html)**
- **[åŒäº²å§”æ´¾æ¨¡å‹](./åŒäº²å§”æ´¾æ¨¡å‹.html)**
- **[â¤ï¸â€ğŸ”¥ è‡ªå®šä¹‰ç±»åŠ è½½å™¨](./è‡ªå®šä¹‰ç±»åŠ è½½å™¨.html)**
- **[ç ´ååŒäº²å§”æ´¾æ¨¡å‹](./ç ´ååŒäº²å§”æ´¾æ¨¡å‹.html)**

# è‡ªå®šä¹‰ç±»åŠ è½½å™¨

å¯¹äºç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬çŸ¥é“é‡ç‚¹æ˜¯`loadClass`æ–¹æ³•, åŒäº²å§”æ´¾æ¨¡å‹ä¹Ÿæ˜¯åœ¨`loadClass`æ–¹æ³•é‡Œé¢å®ç°çš„ã€‚`loadClass`æ–¹æ³•é‡Œé¢å®é™…ä¸Šå»åŠ è½½ç±»çš„æ˜¯`findClass`æ–¹æ³•ã€‚å¯¹äºæˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ¥è¯´éœ€è¦åšåˆ°ä¸¤ç‚¹å³å¯

- è¿™ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ç»§æ‰¿è‡ª`ClassLoader`ç±»
- è¿™ä¸ªç±»åŠ è½½å™¨è¦é‡å†™`ClassLoader`ç±»ä¸­çš„`findClass`æ–¹æ³•

### <font color=#1FA774>ç¬¬ä¸€æ­¥ï¼šç»§æ‰¿ ClassLoader ç±»</font>

è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç»§æ‰¿è‡ª`ClassLoader`æŠ½è±¡ç±»ï¼Œç„¶åå®šä¹‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œç”¨æ¥æ¥æ”¶è¦åŠ è½½çš„ç±»å

```java
public class MyClassLoader extends ClassLoader {

    private String classPath;

    public MyClassLoader(String classPath) {
        this.classPath = classPath;
    }
}
```

### <font color=#1FA774>ç¬¬äºŒæ­¥ï¼šé‡å†™ findClass æ–¹æ³•</font>

```java
public class MyClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) {
        try {
            byte[] data = loadByte(name);
            return defineClass(name, data, 0, data.length);
        } catch (IOException e) {
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }

    private byte[] loadByte(String name) throws IOException {
        String fileName = name.replace(".", "/").concat(".class");
        FileInputStream fileInputStream = new FileInputStream(classPath + "/" + fileName);
        int len = fileInputStream.available();
        byte[] data = new byte[len];
        int read = fileInputStream.read(data);
        fileInputStream.close();
        return data;
    }
}
```

### <font color=#1FA774>ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•</font>

**<font color='red'>æ³¨æ„ï¼š</font>**æµ‹è¯• class æ–‡ä»¶ä¸èƒ½æ”¾åˆ°ç±»è·¯å¾„ä¸‹ï¼Œä¸ç„¶ä¼šè¢«åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨åŠ è½½ï¼ï¼

```java
public static void main(String[] args) throws ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException, InvocationTargetException {
    MyClassLoader myClassLoader = new MyClassLoader("/Users/lfool/myself/temp/java/");
    Class<?> c = myClassLoader.loadClass("com.lfool.myself.Test03");
    Object obj = c.newInstance();
    Method f = c.getDeclaredMethod("f", null);
    f.invoke(obj, null);
    System.out.println(c.getClassLoader().getClass().getName());
}
```

è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ**<font color='red'>ä¸ºä»€ä¹ˆè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯ AppClassLoaderï¼Ÿï¼Ÿ</font>**

é¦–å…ˆï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ç»§æ‰¿`ClassLoader`ï¼Œè°ƒç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„æ„é€ å‡½æ•°ä¹‹å‰ä¼šå…ˆå»è°ƒç”¨`ClassLoader`çš„æ— å‚æ„é€ å‡½æ•°

```java
protected ClassLoader() {
    // è°ƒç”¨è‡ªèº«æ„é€ å‡½æ•°
    this(checkCreateClassLoader(), getSystemClassLoader());
}
private ClassLoader(Void unused, ClassLoader parent) {
    // èµ‹å€¼ parentï¼Œæ­¤å¤„çš„ parent æ˜¯ getSystemClassLoader() çš„å€¼ï¼Œå…·ä½“è§ä¸‹æ–¹
    this.parent = parent;
    if (ParallelLoaders.isRegistered(this.getClass())) {
        parallelLockMap = new ConcurrentHashMap<>();
        package2certs = new ConcurrentHashMap<>();
        assertionLock = new Object();
    } else {
        parallelLockMap = null;
        package2certs = new Hashtable<>();
        assertionLock = this;
    }
}
@CallerSensitive
public static ClassLoader getSystemClassLoader() {
    // å…·ä½“è§ä¸‹æ–¹
    initSystemClassLoader();
    if (scl == null) {
        return null;
    }
    SecurityManager sm = System.getSecurityManager();
    if (sm != null) {
        checkClassLoaderPermission(scl, Reflection.getCallerClass());
    }
    return scl;
}
private static synchronized void initSystemClassLoader() {
    if (!sclSet) {
        if (scl != null)
            throw new IllegalStateException("recursive invocation");
        sun.misc.Launcher l = sun.misc.Launcher.getLauncher();
        if (l != null) {
            Throwable oops = null;
            // æ­¤å¤„è°ƒç”¨çš„æ˜¯ Launcher ä¸­çš„ getClassLoader æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ ppClassLoader.getAppClassLoader(extcl)
            scl = l.getClassLoader();
            try {
                scl = AccessController.doPrivileged(
                    new SystemClassLoaderAction(scl));
            } catch (PrivilegedActionException pae) {
                oops = pae.getCause();
                if (oops instanceof InvocationTargetException) {
                    oops = oops.getCause();
                }
            }
            if (oops != null) {
                if (oops instanceof Error) {
                    throw (Error) oops;
                } else {
                    // wrap the exception
                    throw new Error(oops);
                }
            }
        }
        sclSet = true;
    }
}
```