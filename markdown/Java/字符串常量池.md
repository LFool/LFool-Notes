# å­—ç¬¦ä¸²å¸¸é‡æ± 

å‰æ–‡ä»‹ç»äº† **[è¿è¡Œæ—¶å¸¸é‡æ± ](./è¿è¡Œæ—¶å¸¸é‡æ± .html)**ï¼Œå®ƒå’Œæœ¬ç¯‡æ–‡ç« è¦ä»‹ç»çš„ã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€æ˜¯åŒ…å«å…³ç³»

åœ¨ JDK7 åŠä»¥åï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± è¢«æŒªåˆ°äº† Java å †ä¸­ï¼Œä½†è¿™å¹¶ä¸å½±å“å®ƒçš„ä½œç”¨ï¼Œåªæ˜¯ä½ç½®å‘ç”Ÿäº†å˜åŒ–

### <font color=#1FA774>String ç±»</font>

é€šè¿‡åå­—ï¼Œç¬¬ä¸€å°è±¡å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼Œã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€å°±æ˜¯ä¸“é—¨ç”¨æ¥å­˜æ”¾å­—ç¬¦ä¸²çš„å¸¸é‡æ± ï¼Œæ‰€ä»¥å…ˆæ¥ä»‹ç»ä¸€ä¸‹`String`ç±»

**<font color='red'>æ³¨æ„ï¼š</font>**ä¸‹é¢å‡ºç°çš„ä»£ç å¤§å¤šéƒ½æ˜¯ä»æºç ä¸­æ‘˜å‡ºæ¥çš„ï¼æœ‰å…´è¶£çš„å¯ä»¥ç»“åˆ`String`æºç ä¸€èµ·è§‚çœ‹ï¼ï¼

#### <font color=#9933FF>å…³é”®ç‚¹ä¸€</font>

é¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯`String`æ˜¯ä¸€ä¸ª`final`ç±»ï¼š

```java
// String ç±»ä¸èƒ½è¢«ç»§æ‰¿
public final class String
    implements java.io.Serializable, Comparable<String>, CharSequence {
    // ...
}
```

#### <font color=#9933FF>å…³é”®ç‚¹äºŒ</font>

å…¶æ¬¡éœ€è¦çŸ¥é“çš„æ˜¯`String`ä¸­å­˜å‚¨æ•°æ®çš„ç»“æ„æ˜¯ä¸€ä¸ª`char[]`æ•°ç»„ï¼š

```java
// private + final è®© String å¯¹è±¡ä¸å¯å˜ï¼Œè¿™æ˜¯å®ç°å­—ç¬¦ä¸²å¸¸é‡æ± çš„åŸºç¡€ï¼ï¼
private final char value[];
```

**<font color='red'>æ‰©å±•ï¼š</font>**åœ¨ JDK9 ä¹‹åï¼Œ`String`çš„åº•å±‚æ•°æ®ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
private final byte[] value;
```

**ğŸ‘‰ [JEP 254: Compact Strings](https://openjdk.org/jeps/254)**

**Motivation: **The current implementation of the String class stores characters in a char array, using two bytes (sixteen bits) for each character. Data gathered from many different applications indicates that strings are a major component of heap usage and, moreover, that most String objects contain only Latin-1 characters. Such characters require only one byte of storage, hence half of the space in the internal char arrays of such String objects is going unused.

**è§£é‡Šï¼š**ä½¿ç”¨`char[]`æ•°ç»„å­˜å‚¨æ•°æ®çš„è¯ï¼Œæ¯ä¸ªå­—ç¬¦å ç”¨ 2 ä¸ªå­—èŠ‚ (16 bits)ï¼›ç„¶è€Œç»å¤§å¤šæ•°å­—ç¬¦ä¸²å¯¹è±¡ä¸­ä»…ä»…åªåŒ…å« Latin-1 å­—ç¬¦ï¼Œå­˜å‚¨è¿™äº›å­—ç¬¦èŠ± 1 ä¸ªå­—èŠ‚å³å¯ã€‚æ‰€ä»¥å¦‚æœéƒ½ç”¨ 2 ä¸ªå­—èŠ‚å»å­˜å‚¨ï¼Œå°†ä¼šæµªè´¹å¤§é‡çš„ç©ºé—´

**<font color='red'>é—®é¢˜ï¼š</font>**å¦‚ä½•å­˜å‚¨å¿…é¡»éœ€è¦ 2 ä¸ªå­—èŠ‚çš„å­—ç¬¦å‘¢ï¼Ÿï¼Ÿ

**Description:** We propose to change the internal representation of the String class from a UTF-16 char array to a byte array plus **an encoding-flag field**. 

**è§£é‡Šï¼š**`String`ä¸­æœ‰ä¸€ä¸ª**ç¼–ç æ ‡å¿—åŸŸ**ï¼Œæ¥æ ‡è¯†å½“å‰å­˜å‚¨æ•°æ®çš„ç¼–ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// ç¼–ç æ ‡å¿—åŸŸ
private final byte coder;
// æ˜¯å¦é‡‡ç”¨å‹ç¼©å­˜å‚¨
static final boolean COMPACT_STRINGS;
static {
    // é»˜è®¤ä½¿ç”¨
    COMPACT_STRINGS = true;
}
// è¿”å›å½“å‰ç¼–ç æ ‡å¿—åŸŸ
byte coder() {
    return COMPACT_STRINGS ? coder : UTF16;
}
// å½“æ±‚å­—ç¬¦ä¸²é•¿åº¦æ—¶ï¼Œéœ€è¦æ ¹æ® coder
public int length() {
    return value.length >> coder();
}
```

**<font color='red'>æ³¨æ„ï¼š</font>**String-related classes such as AbstractStringBuilder, StringBuilder, and StringBuffer will be updated to use the same representation, as will the HotSpot VM's intrinsic string operations.

**è§£é‡Šï¼š**ä¸å­—ç¬¦ä¸²ç›¸å…³çš„ç±»ï¼Œå¦‚`AbstractStringBuilder`ã€`StringBuilder`å’Œ`StringBuffer`å°†è¢«æ›´æ–°ä»¥ä½¿ç”¨ç›¸åŒçš„è¡¨ç¤ºæ–¹æ³•ï¼ŒHotSpot è™šæ‹Ÿæœºçš„å†…åœ¨å­—ç¬¦ä¸²æ“ä½œä¹Ÿæ˜¯å¦‚æ­¤

#### <font color=#9933FF>å…³é”®ç‚¹ä¸‰</font>

æœ€åä»‹ç»å››ç§åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡çš„æ–¹æ³•ï¼š

```java
String s1 = "abc";                     // æ–¹æ³• 1
String s2 = String.valueOf("abc");     // æ–¹æ³• 2
String s3 = new String("abc");         // æ–¹æ³• 3
char[] chars = {'a', 'b', 'c'};
String s4 = new String(chars);         // æ–¹æ³• 4
```

### <font color=#1FA774>å­—ç¬¦ä¸²å¸¸é‡æ± çš„æ•°æ®ç»“æ„</font>

å­—ç¬¦ä¸²å¸¸é‡æ± åº•å±‚æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„`HashTable`ï¼Œå¦‚æœé•¿åº¦æ¯”è¾ƒå°ï¼Œå½“æ”¾è¿›å»çš„å­—ç¬¦ä¸²å¯¹è±¡ç‰¹åˆ«å¤šï¼Œå°±ä¼šé€ æˆä¸¥é‡çš„ Hash å†²çªä»è€Œå¯¼è‡´é“¾è¡¨å¾ˆé•¿ï¼Œæ›´è¿‘ä¸€æ­¥å¯¼è‡´è°ƒç”¨`String::intern`æ–¹æ³•æ—¶æ•ˆç‡ä½

å¯ä»¥ä½¿ç”¨å‚æ•°`-XX:StringTableSize=size`è®¾ç½® StringTable çš„å¤§å°

- åœ¨ JDK6 ä¸­ï¼ŒStringTable æ˜¯å›ºå®šçš„ï¼Œé•¿åº¦ä¸º 1009ï¼Œæ‰€ä»¥å¦‚æœå¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤šå°±ä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™å¾ˆå¿« (StringTableSize è®¾ç½®æ—¶æ²¡æœ‰è¦æ±‚)
- åœ¨ JDK7 ä¸­ï¼ŒStringTable çš„é•¿åº¦é»˜è®¤å€¼æ˜¯ 60013 (StringTableSize è®¾ç½®æ—¶æ²¡æœ‰è¦æ±‚)
- åœ¨ JDK8 ä¸­ï¼ŒStringTable çš„é•¿åº¦é»˜è®¤å€¼æ˜¯ 60013ï¼Œæ‰‹åŠ¨è®¾ç½® StringTable é•¿åº¦ï¼Œæœ€å°å€¼ä¸èƒ½ä½äº 1009

**<font color='red'>åœ¨ JDK7 åŠä¹‹åï¼Œã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€è¢«ç§»åˆ°äº†å †ä¸­ï¼Œè€Œå¯¹è±¡ä¹Ÿæ˜¯åœ¨å †ä¸­ï¼Œæ­¤æ—¶ã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€ä¸­å­˜å‚¨çš„åªæ˜¯å®ä¾‹å¼•ç”¨ï¼ï¼</font>**ä¸‹é¢çš„è®¨è®ºå‡åŸºäº JDK7 åŠä¹‹åï¼Œå¦‚æœæœ‰ä¾‹å¤–ï¼Œä¼šå¦å¤–è¯´æ˜

### <font color=#1FA774>åˆçº§æ¯”è¾ƒ</font>

**å…³äºå¯¹è±¡å¼•ç”¨ç›´æ¥ç”¨`= =`æ¯”è¾ƒçš„è¯¦ç»†åˆ†æå¯è§ [ã€Œequalsã€ã€ŒhashCodeã€](./equals-hashCode.html)**

æ¥ç€ä¸Šä¸€éƒ¨åˆ†ï¼Œå¦‚æœ`s1`ç›´æ¥å’Œ`s2, s3, s4`ç”¨`= =`åšæ¯”è¾ƒï¼Œç»“æœä¼šå¦‚ä½•ï¼Ÿå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```java
// çœç•¥å‰é¢ä»£ç  ...
System.out.println(s1 == s2);  // true
System.out.println(s1 == s3);  // false
System.out.println(s1 == s4);  // false
```

é¦–å…ˆé€šè¿‡ JProfiler è½¯ä»¶ï¼ŒæŸ¥çœ‹ä¸€ä¸‹è¿™äº›å¯¹è±¡åœ¨å †ä¸­çš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://cdn.jsdelivr.net/gh/LFool/image-hosting@master/20221119/1511311668841891xUD3sV8.svg" alt="8" style="zoom: 40%;" />

ä¸Šå›¾å¯¹åº”çš„å¯è§†åŒ–è§£é‡Šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![7](https://cdn.jsdelivr.net/gh/LFool/image-hosting@master/20221119/1530371668843037yH7qpI7.svg)

å¯¹äº`String s1 = "abc"`æ¥è¯´ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå­—ç¬¦æ•°ç»„ç±»å‹çš„å­—æ®µ`value`ï¼Œå­˜å‚¨å®é™…çš„æ•°æ®ã€‚**<font color='red'>æ‰€æœ‰åŒå¼•å·`"xxx"`ä¸­çš„å†…å®¹éƒ½åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼ï¼</font>**æ‰€ä»¥`"abc"`åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œæ›´å‡†ç¡®ä¸€ç‚¹ï¼Œæ˜¯åœ°å€ä¸º`0xb5d`çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­

å¯¹äº`String s2 = String.valueOf("abc")`æ¥è¯´ï¼Œå…ˆçœ‹ä¸€ä¸‹`valueOf()`æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public static String valueOf(Object obj) {
    // toString() è§ä¸‹æ–¹
    return (obj == null) ? "null" : obj.toString();
}
public String toString() {
    return this;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æŠŠä¼ å…¥çš„å¯¹è±¡è¿”å›äº†ï¼Œæ‰€ä»¥æ–¹æ³• 2 å’Œæ–¹æ³• 1 æ˜¯ç­‰ä»·çš„ï¼

å¯¹äº`String s3 = new String("abc")`æ¥è¯´ï¼Œå…ˆçœ‹ä¸€ä¸‹å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public String(String original) {
    this.value = original.value;
    this.hash = original.hash;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå°†ä¼ å…¥å‚æ•°çš„`value`å’Œ`hash`å­—æ®µèµ‹å€¼ç»™è‡ªèº«çš„`value`å’Œ`hash`å­—æ®µã€‚ä¸¾ä¸ªå¾ˆå½¢è±¡çš„ä¾‹å­ï¼Œå¦‚æœä¼ å…¥çš„å¯¹è±¡æ˜¯ç¾Šï¼Œé‚£ä¹ˆ`new`å‡ºæ¥çš„æ–°å¯¹è±¡å°±æ˜¯æŠ«ç€ç‹¼çš®çš„ç¾Š

å¯¹äº`String s4 = new String(chars)`æ¥è¯´ï¼ŒåŒæ ·çš„ï¼Œå…ˆçœ‹ä¸€ä¸‹å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public String(char value[]) {
    this.value = Arrays.copyOf(value, value.length);
}
```

ä¸Šé¢è¯´è¿‡ï¼Œ`String`å¯¹è±¡å­˜å‚¨æ•°æ®çš„ç»“æ„æ˜¯ä¸€ä¸ª`char[]`æ•°ç»„ï¼Œæ‰€ä»¥è¿™ä¸ªæ„é€ å‡½æ•°ç›¸å½“äºæŠŠä¼ å…¥çš„æ•°ç»„ copy äº†ä¸€ä»½ï¼Œç„¶åèµ‹å€¼ç»™è‡ªèº«çš„`value`å­—æ®µ

**<font color='red'>ç»¼ä¸Šæ‰€è¿°ï¼š</font>**å¦‚æœåªæ˜¯ç»™`value`å’Œ`hash`å­—æ®µèµ‹äº†ç›¸åŒçš„å€¼ï¼Œä½†å¯¹è±¡è¿˜æ˜¯ä¸åŒçš„ï¼›ç”¨`= =`ç›´æ¥æ¯”è¾ƒï¼Œæ¯”è¾ƒçš„æ˜¯å¯¹è±¡çš„åœ°å€æ˜¯å¦ç›¸åŒï¼ï¼

**<font color='red'>æ‰©å±•ï¼š</font>**ç»§ç»­çœ‹ä¸€ä¸‹ç”¨`equals()`æ–¹æ³•æ¯”è¾ƒçš„åŸç†ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public boolean equals(Object anObject) {
    // ç°åœ¨ç›´æ¥æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡åœ°å€ã€‚å¦‚æœåœ°å€ç›¸åŒï¼Œè‚¯å®šç›¸ç­‰
    if (this == anObject) {
        return true;
    }
    // çœ‹çœ‹æ¯”è¾ƒçš„ä¸¤ä¸ªå¯¹è±¡ç±»å‹æ˜¯å¦ç›¸åŒã€‚å¦‚æœä¸åŒï¼Œç›´æ¥è¿”å› false
    if (anObject instanceof String) {
        String anotherString = (String)anObject;
        int n = value.length;
        if (n == anotherString.value.length) {
            // å¯ä»¥çœ‹åˆ°æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„ value å­—ç¬¦æ•°ç»„æ˜¯å¦ç›¸åŒ 
            char v1[] = value;
            char v2[] = anotherString.value;
            int i = 0;
            while (n-- != 0) {
                if (v1[i] != v2[i])
                    return false;
                i++;
            }
            return true;
        }
    }
    return false;
}
```

### <font color=#1FA774>é«˜çº§æ¯”è¾ƒ</font>

ä¸Šé¢çš„åˆçº§æ¯”è¾ƒä¸­ï¼Œéƒ½æ˜¯ç®€å•ç›´æ¥ç»™å‡ºä¸€ä¸ªå®Œæ•´å­—ç¬¦ä¸²ï¼Œè¿™ä¸€éƒ¨åˆ†ä»‹ç»å‡ ç§é«˜çº§æ¯”è¾ƒï¼ï¼

#### <font color=#9933FF>å­—ç¬¦ä¸²æ‹¼æ¥èµ‹å€¼</font>

ä¸¤ä¸ªå­—ç¬¦ä¸²ç›´æ¥æ‹¼æ¥åœ¨ä¸€èµ·çš„æƒ…å†µï¼

```java
String s1 = "abcdef";
String s2 = "abc" + "def";
System.out.println(s1 == s2);  // true
```

é€šè¿‡ JProfiler è½¯ä»¶å‘ç° Java å †ä¸­å¹¶æ²¡æœ‰`"abc"`å’Œ`"def"`ï¼Œåªæœ‰`"abcdef"`ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿï¼Ÿ

é€šè¿‡`javap`åç¼–è¯‘ Class æ–‡ä»¶åï¼Œå‘ç°å¸¸é‡æ± ä¸­åªæœ‰`abcdef`ï¼›ä¸º`s2`èµ‹å€¼æ—¶ï¼Œä¹Ÿæ˜¯ç›´æ¥æŠŠ`abcdef`èµ‹ç»™äº†`s2`ï¼Œå¹¶æ²¡æœ‰æ‹¼æ¥çš„è¿‡ç¨‹ï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// éƒ¨åˆ†å¸¸é‡æ± 
#30 = Utf8               abcdef
// ä¸º s2 èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤ 
3: ldc           #2                  // String abcdef
5: astore_2
```

è¿™æ˜¯å› ä¸ºåœ¨ç¼–è¯‘é˜¶æ®µï¼Œè¿›è¡Œäº†ä¸€æ³¢ä¼˜åŒ–ï¼ï¼(**<font color='red'>ç¼–è¯‘æœŸä¼˜åŒ–</font>**) ä¸ä»…æ˜¯å­—ç¬¦ä¸²ï¼Œæ•´å‹å¸¸é‡ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// æºç 
int a = 5 + 6;
// ä¸º a èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤ 
0: bipush        11
2: istore_1
```

#### <font color=#9933FF>å­—ç¬¦ä¸²å’Œå˜é‡çš„æ‹¼æ¥èµ‹å€¼</font>

**<font color='red'>ä¾‹å­ä¸€</font>**

```java
String s1 = "abc";
System.out.println(s1 + "def" == "abcdef");  // false
```

é¦–å…ˆå¯ä»¥çŸ¥é“ç¼–è¯‘é˜¶æ®µæ²¡æœ‰è¿›è¡Œå’Œä¸Šé¢ä¸€æ ·çš„ä¼˜åŒ–ï¼Œè€Œä¸”ä»åº•å±‚æ¥çœ‹ï¼Œæ­¤å¤„çš„æ‹¼æ¥æ˜¯å€ŸåŠ©`StringBuilder`å®Œæˆçš„ï¼Œä¸Šé¢ä»£ç å’Œä¸‹é¢çš„ä»£ç ç­‰ä»· (ç¼–è¯‘åçš„å­—èŠ‚æŒ‡ä»¤å®Œå…¨ä¸€æ ·)ï¼š

```java
String s1 = "abc";
System.out.println(new StringBuilder().append(s1).append("def").toString() == "abcdef"); // false
```

ä¸‹é¢ç»™å‡ºç¼–è¯‘åçš„å­—èŠ‚ç æŒ‡ä»¤ï¼š

```java
Code:
  stack=3, locals=1, args_size=0
     0: ldc           #2                  // String abc
     2: astore_0
     3: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;
     6: new           #4                  // class java/lang/StringBuilder
     9: dup
    10: invokespecial #5                  // Method java/lang/StringBuilder."<init>":()V
    13: aload_0
    14: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
    17: ldc           #7                  // String def
    19: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
    22: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
    25: ldc           #9                  // String abcdef
    27: if_acmpne     34
    30: iconst_1
    31: goto          35
    34: iconst_0
    35: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V
    38: return
```

ä¸Šé¢ä»å­—èŠ‚ç çš„è§’åº¦åˆ†æäº†**ç­‰ä»·æ€§**ï¼Œä¸‹é¢ä»å†…å­˜çš„è§’åº¦åˆ†æä¸ºä»€ä¹ˆä¸ç›¸ç­‰ï¼

é¦–å…ˆææ¸…æ¥šå“ªäº›å­—ç¬¦ä¸²åœ¨**å­—ç¬¦ä¸²å¸¸é‡æ± **ä¸­ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± çš„æœ‰ï¼š`"abc", "def", "abcdef"`ï¼Œé€šè¿‡ JProfiler éªŒè¯å¦‚ä¸‹ï¼š

<img src="https://cdn.jsdelivr.net/gh/LFool/image-hosting@master/20221119/1722001668849720ykUYmf8.svg" alt="8" style="zoom:67%;" />

ç„¶ååœ¨çœ‹çœ‹çœ‹`StringBuilder::toString`çš„æºç ï¼š

```java
@Override
public String toString() {
    // Create a copy, don't share the array
    return new String(value, 0, count);
}
public String(char value[], int offset, int count) {
    if (offset < 0) {
        throw new StringIndexOutOfBoundsException(offset);
    }
    if (count <= 0) {
        if (count < 0) {
            throw new StringIndexOutOfBoundsException(count);
        }
        if (offset <= value.length) {
            this.value = "".value;
            return;
        }
    }
    // Note: offset or count might be near -1>>>1.
    if (offset > value.length - count) {
        throw new StringIndexOutOfBoundsException(offset + count);
    }
    // copy äº†ä¸€ä»½ï¼ï¼
    this.value = Arrays.copyOfRange(value, offset, offset+count);
}
```

`StringBuilder`ä¸­ä¹Ÿæ˜¯ç”¨`char[] value`æ¥å­˜å‚¨å­—ç¬¦ï¼Œè€Œ`StringBuilder::toString`æ–¹æ³•ä¼šè°ƒç”¨`String`çš„æ„é€ å‡½æ•°`public String(char value[], int offset, int count)`

è¿™ä¸ªæ„é€ å‡½æ•°æ˜¯ copy äº†ä¸€ä»½`value`å­—ç¬¦æ•°ç»„ï¼Œè€Œä¸æ˜¯ç›´æ¥æŠŠ`value`èµ‹å€¼ç»™è‡ªèº«ï¼Œå’Œ`public String(char value[])`å·®ä¸å¤šï¼Œæ³¨æ„å’Œ`public String(String original)`åŒºåˆ†ï¼ï¼

å¯è§†åŒ–è§£é‡Šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![9](https://cdn.jsdelivr.net/gh/LFool/image-hosting@master/20221119/1939521668857992YreKDY9.svg)

**<font color='red'>ä¾‹å­äºŒ</font>**

ä¸‹é¢å†ç»™ä¸€ä¸ªç¨å¾®ç‰¹æ®Šçš„ä¾‹å­ï¼š

```java
final String s1 = "abc";
String s2 = s1 + "def";
System.out.println(s2 == "abcdef");  // true
```

å”¯ä¸€çš„ä¸åŒåœ¨äº`s1`å‰é¢è¢«`final`ä¿®é¥°ï¼Œ`s1`æ˜¯å¸¸é‡ï¼Œä¸èƒ½å†æŒ‡å‘å…¶ä»–å­—ç¬¦ä¸²å¯¹è±¡

é¦–å…ˆææ¸…æ¥šç¼–è¯‘å**å¸¸é‡æ± **ä¸­æœ‰ä»€ä¹ˆï¼Œå¸¸é‡æ± çš„æœ‰ï¼š`"abc", "abcdef"`ï¼Œå¹¶æ²¡æœ‰`"def"`ã€‚é¡ºä¾¿çœ‹ä¸€ä¸‹ç¼–è¯‘åçš„å­—èŠ‚ç æŒ‡ä»¤ï¼š

```java
Code:
  stack=3, locals=3, args_size=1
     0: ldc           #2                  // String abc
     2: astore_1
     3: ldc           #3                  // String abcdef
     5: astore_2
     6: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
     9: ldc           #2                  // String abc
    11: aload_2
    12: if_acmpne     19
    15: iconst_1
    16: goto          20
    19: iconst_0
    20: invokevirtual #5                  // Method java/io/PrintStream.println:(Z)V
    23: return
```

æˆ‘ä»¬å‘ç°è¿™ä¸ªæ—¶å€™çš„æ‹¼æ¥å¹¶æ²¡æœ‰åƒä¸Šé¢é‚£æ ·å€ŸåŠ©`StringBuilder`ï¼Œç”šè‡³è¿æ‹¼æ¥çš„è¿‡ç¨‹éƒ½æ²¡æœ‰å‘ç°ï¼Œéƒ½æ²¡æœ‰çœ‹åˆ°`"def"`ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è‚¯å®šå’Œ`final`ä¿®é¥°æœ‰å…³ (åºŸè¯)ï¼Œè¢«`final`ä¿®é¥°åï¼Œ`s1`æ˜¯å¸¸é‡ï¼Œè€Œ`"def"`ä¹Ÿæ˜¯å¸¸é‡

æ‰€ä»¥ç›´æ¥åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡ä¼˜åŒ–æŠŠ`s1 + "def"`çš„ç»“æœè®¡ç®—å‡ºæ¥äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¸¸é‡æ± ä¸­æ²¡æœ‰`"def"`ï¼Œä½†æ˜¯æœ‰`"abcdef"`çš„åŸå› 

é‚£ä¸ºä»€ä¹ˆä¸Šä¸€ä¸ªä¾‹å­ä¸èƒ½è¿™æ ·å¤„ç†å‘¢ï¼Ÿï¼ä¸Šé¢ä¸€ä¸ªä¾‹å­ä¸­`s1`ä¸æ˜¯å¸¸é‡ï¼Œç¼–è¯‘é˜¶æ®µå¹¶ä¸èƒ½çŸ¥é“`s1`åˆ°åº•æŒ‡å‘å“ªä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œåªæœ‰åœ¨è¿è¡ŒæœŸé—´æ‰èƒ½çŸ¥é“ï¼ï¼ï¼

#### <font color=#9933FF>å­—ç¬¦ä¸²å’Œå¼•ç”¨æ‹¼æ¥èµ‹å€¼</font>

```java
String s1 = "abc" + new String("def");
System.out.println(s1 == "abcdef");  // false
```

è¿™ä¸ªå’Œä¸Šé¢ **[å­—ç¬¦ä¸²å’Œå˜é‡çš„æ‹¼æ¥èµ‹å€¼](./å­—ç¬¦ä¸²å¸¸é‡æ± .html#å­—ç¬¦ä¸²å’Œå˜é‡çš„æ‹¼æ¥èµ‹å€¼)** çš„ç¬¬ä¸€ä¸ªä¾‹å­å·®ä¸å¤šï¼Œå­—èŠ‚ç å±‚é¢éƒ½æ˜¯é€šè¿‡`StringBuilder`æ‹¼æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
Code:
  stack=4, locals=2, args_size=1
     0: new           #2                  // class java/lang/StringBuilder
     3: dup
     4: invokespecial #3                  // Method java/lang/StringBuilder."<init>":()V
     7: ldc           #4                  // String abc
     9: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
    12: new           #6                  // class java/lang/String
    15: dup
    16: ldc           #7                  // String def
    18: invokespecial #8                  // Method java/lang/String."<init>":(Ljava/lang/String;)V
    21: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
    24: invokevirtual #9                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
    27: astore_1
    28: getstatic     #10                 // Field java/lang/System.out:Ljava/io/PrintStream;
    31: aload_1
    32: ldc           #11                 // String abcdef
    34: if_acmpne     41
    37: iconst_1
    38: goto          42
    41: iconst_0
    42: invokevirtual #12                 // Method java/io/PrintStream.println:(Z)V
    45: return
```

#### <font color=#9933FF>å¼•ç”¨æ‹¼æ¥èµ‹å€¼</font>

```java
String s1 = new String("abc") + new String("def");
System.out.println(s1 == "abcdef");  // false
```

åŸå› åŒä¸Šï¼Œå¯ä»¥çœ‹åç¼–è¯‘åçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œé€šè¿‡`StringBuilder`æ‹¼æ¥ï¼Œä¸ºäº†èŠ‚çº¦ç¯‡å¹…ï¼Œè¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†ï¼

#### <font color=#9933FF>æ€§èƒ½æ¯”è¾ƒ</font>

é€šè¿‡ä¸Šé¢çš„åˆ†æï¼ŒçŸ¥é“äº†å­—ç¬¦ä¸²ç›´æ¥ç”¨`+`æ‹¼æ¥ï¼Œåº•å±‚æ˜¯é€šè¿‡`StringBuilder`å®ç°ï¼Œä¸‹é¢ç»™å‡ºä¸¤ç§ä¸åŒæ–¹å¼çš„æ€§èƒ½æ¯”è¾ƒï¼š

```java
public class CompareStringAdd {
    public static void main(String[] args) {
        int count = 1000000;
        long start = System.currentTimeMillis();
        f1(count);
        long end = System.currentTimeMillis();
        System.out.println(end - start);        // 42392

        start = System.currentTimeMillis();
        f2(count);
        end = System.currentTimeMillis();
        System.out.println(end - start);        // 6
    }
    public static void f1(int count) {
        String s = "";
        for (int i = 0; i < count; i++) {
            s += "a";
        }
    }
    public static void f2(int count) {
        StringBuilder s = new StringBuilder();
        for (int i = 0; i < count; i++) {
            s.append("a");
        }
    }
}
```

å¯ä»¥çœ‹åˆ°è¿™å·®è·è¿˜æ˜¯å¾ˆæ˜æ˜¾æ»´ï¼ï¼

å¯¹äº`f1()`æ–¹æ³•ï¼Œå¾ªç¯ä¸­çš„æ¯ä¸€æ¬¡åŠ æ“ä½œéƒ½ä¼šç»å†ä¸‰ä¸ªæ­¥éª¤ï¼šåˆ›å»º`StringBuilder`å¯¹è±¡ï¼›è°ƒç”¨ä¸€æ¬¡`append()`æ–¹æ³•ï¼›è°ƒç”¨ä¸€æ¬¡`toString()`æ–¹æ³•ç”Ÿæˆä¸€ä¸ª`String`å¯¹è±¡

å¯æƒ³è€ŒçŸ¥å†…å­˜ä¸­ä¼šåˆ›å»ºå¾ˆå¤š`StringBuilder`å’Œ`String`å¯¹è±¡ï¼Œå†…å­˜å ç”¨å¤§ï¼›å¦‚æœè¿›è¡Œ GCï¼Œè¿˜éœ€è¦èŠ±è´¹é¢å¤–çš„æ—¶é—´å¼€é”€

å¯¹äº`f2()`æ–¹æ³•ï¼Œä»å¾ªç¯å¼€å§‹åˆ°ç»“æŸä»…ä»…åªåˆ›å»ºäº†ä¸€ä¸ª`StringBuilder`å¯¹è±¡ï¼Œæ¯ä¸€è½®å¾ªç¯ä»…ä»…æ˜¯è°ƒç”¨äº†ä¸€æ¬¡`append()`æ–¹æ³•è€Œå·²ï¼Œæ‰€ä»¥æ•ˆç‡ä¸Šçš„æå‡ä¹Ÿæ˜¯è‚‰çœ¼å¯è§çš„

**<font color='red'>è¿™ä¸ªç‚¹ä¹Ÿæ˜¯é˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œä¸­æ‰€æ¨èçš„ï¼šå¾ªç¯ä½“å†…ï¼Œå­—ç¬¦ä¸²çš„è¿æ¥æ–¹å¼ï¼Œä½¿ç”¨ StringBuilder çš„ append æ–¹æ³•è¿›è¡Œæ‰©å±•</font>**

**<font color='red'>æ€è€ƒï¼š</font>**å¯¹äº`f2()`æ–¹æ³•ï¼Œæœ‰æ²¡æœ‰å¯ä»¥ç»§ç»­ä¼˜åŒ–çš„åœ°æ–¹å‘¢ï¼Ÿ-> **æ—¢ç„¶è¿™æ ·è¯´äº†ï¼Œç­”æ¡ˆè‚¯å®šæ˜¯æœ‰ï¼ï¼ï¼**

å…ˆæ¥çœ‹çœ‹`StringBuilder`çš„æ— å‚æ„é€ å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public StringBuilder() {
    // é»˜è®¤åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 16 çš„ StringBuilder å¯¹è±¡
    super(16);
}
```

å†æ¥çœ‹çœ‹`append()`æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Override
public StringBuilder append(String str) {
    // å…·ä½“è§ä¸‹æ–¹
    super.append(str);
    return this;
}
// AbstractStringBuilder ç±»ï¼ŒStringBuilder ç»§æ‰¿è¯¥ç±»
public AbstractStringBuilder append(String str) {
    if (str == null)
        return appendNull();
    int len = str.length();
    // åˆ¤æ–­æ˜¯å¦ä¼šè¶Šç•Œï¼Œå…·ä½“è§ä¸‹æ–¹
    ensureCapacityInternal(count + len);
    str.getChars(0, len, value, count);
    count += len;
    return this;
}
private void ensureCapacityInternal(int minimumCapacity) {
    // overflow-conscious code
    if (minimumCapacity - value.length > 0) {
        // æ–°å»ºä¸€ä¸ªæ›´å¤§çš„ value æ•°ç»„ï¼Œå¹¶å°†åŸæ¥æ•°ç»„çš„å†…å®¹å¤åˆ¶è¿‡æ¥
        // newCapacity è§ä¸‹æ–¹
        value = Arrays.copyOf(value, newCapacity(minimumCapacity));
    }
}
private int newCapacity(int minCapacity) {
    // overflow-conscious code
    // åœ¨åŸæœ‰çš„é•¿åº¦ä¸Š x 2 + 2
    int newCapacity = (value.length << 1) + 2;
    // åˆ¤æ–­æ–°é•¿åº¦å¤Ÿä¸å¤Ÿï¼Œå¦‚æœä¸å¤Ÿï¼Œç›´æ¥èµ‹å€¼ä¸º minCapacity
    if (newCapacity - minCapacity < 0) {
        newCapacity = minCapacity;
    }
    return (newCapacity <= 0 || MAX_ARRAY_SIZE - newCapacity < 0)
        ? hugeCapacity(minCapacity)
        : newCapacity;
}
```

æ‰¯äº†è¿™ä¹ˆå¤šï¼Œå°±æ˜¯æƒ³è¯´æ˜å¦‚æœåˆå§‹åŒ–å¤§å°è¿‡å°ï¼Œä¼šé¢‘ç¹çš„æ‰©å®¹ï¼Œæ‰©å®¹åˆæ¶‰åŠåˆ°æ•°ç»„çš„å¤åˆ¶ï¼Œå¸¦æ¥çš„å¼€é”€è¾ƒå¤§

æ‰€ä»¥å¦‚æœåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯ä»¥åŸºæœ¬ç¡®å®šéœ€è¦æ·»åŠ çš„å­—ç¬¦ä¸²é•¿åº¦ä¸é«˜äºæŸä¸ªé™å®šå€¼ï¼Œå»ºè®®ä½¿ç”¨å¸¦å‚æ„é€ å‡½æ•°ï¼Œé¿å…é¢‘ç¹çš„æ‰©å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
StringBuilder s = new StringBuilder(highLevel);
```

### <font color=#1FA774>åˆ°åº•åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ï¼Ÿï¼</font>

#### <font color=#9933FF>é—®é¢˜ä¸€</font>

è¿™æ˜¯ä¸€é“ç»å…¸é¢è¯•çš„é—®é¢˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
String s = new String("abc");
```

é¦–å…ˆå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰ä¸€ä¸ªå¯¹è±¡`"abc"`ï¼›å…¶æ¬¡`new String("abc")`åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ŒæŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„`"abc"`

**æ‰€ä»¥è¿™ä¸ªé—®é¢˜ä¸­åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡ï¼ï¼**

#### <font color=#9933FF>é—®é¢˜äºŒ</font>

ä¸‹é¢æ˜¯è¿›é˜¶ç‰ˆï¼š

```java
String s = new String("abc") + new String("def");
```

é¦–å…ˆå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰ä¸¤ä¸ªå¯¹è±¡`"abc", "def"`;

å…¶æ¬¡`new`äº†ä¸¤ä¸ª`String`å¯¹è±¡ï¼Œåˆ†åˆ«æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„ä¸¤ä¸ªå¯¹è±¡ï¼›

ç„¶å`+`æ‹¼æ¥çš„åº•å±‚æ˜¯é€šè¿‡`StringBuilder`å®ç°ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ª`StringBuilder`å¯¹è±¡

è°ƒç”¨`append()`æ–¹æ³•åï¼Œæœ€ç»ˆä¼šè°ƒç”¨`toString()`æ–¹æ³•ç”Ÿæˆä¸€ä¸ª`String`å¯¹è±¡ï¼Œå¹¶è¿”å›å…¶å¼•ç”¨ç»™`s`

**æ‰€ä»¥è¿™ä¸ªé—®é¢˜ä¸­åˆ›å»ºäº†å…­ä¸ªå¯¹è±¡ï¼ï¼**

### <font color=#1FA774>å­—ç¬¦ä¸²å­—é¢é‡ä½•æ—¶è¿›å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Ÿï¼</font>

å­—ç¬¦ä¸²å­—é¢é‡åœ¨ä¸Šé¢æåˆ°è¿‡ï¼Œæ‰€æœ‰åŒå¼•å·`"xxx"`ä¸­çš„å†…å®¹éƒ½å±äºå­—ç¬¦ä¸²å­—é¢é‡ï¼Œç°åœ¨è®¨è®ºçš„é—®é¢˜æ˜¯è¿™ç§å­—é¢é‡ä»€ä¹ˆæ—¶å€™è¿›å…¥å­—ç¬¦ä¸²å¸¸é‡æ± å‘¢ï¼Ÿï¼Ÿ

é¦–å…ˆå¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œå½“ä¸€ä¸ªæºç¨‹åºè¢«ç¼–è¯‘åï¼Œå­—ç¬¦ä¸²å­—é¢é‡å°±ä¼šè¢«åŠ å…¥é™æ€å¸¸é‡æ± ä¸­ï¼›å½“å¯¹åº”çš„ç±»è¢«åŠ è½½åˆ°å†…å­˜åï¼Œå†…å­˜ä¸­å­˜æ”¾é™æ€å¸¸é‡æ± çš„åœ°æ–¹å°±è¢«ç§°ä¸ºè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œæ‰€ä»¥è¿è¡Œæ—¶å¸¸é‡æ± ä¹Ÿæœ‰è¯¥å­—é¢é‡

åœ¨ç±»åŠ è½½è¿‡ç¨‹çš„è§£æé˜¶æ®µï¼ŒJava è™šæ‹Ÿæœºä¼šåœ¨å †ä¸­åˆ›å»ºå¯¹åº” class æ–‡ä»¶å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡å®ä¾‹ï¼Œå¹¶åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­é©»ç•™å…¶å¼•ç”¨ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å†…å®¹**å…¨å±€å…±äº«**ï¼ï¼

**<font color='red'>ä½†ä½†ä½†ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ˜ç¡®è§„å®šè§£æé˜¶æ®µå¯ä»¥æ˜¯ lazy resolve çš„ï¼ï¼ï¼</font>**

ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­ Class æ–‡ä»¶çš„å¸¸é‡æ± é¡¹ç›®çš„ç±»å‹ï¼Œæœ‰ä¸¤ç§ä¸œè¥¿ï¼š

- CONSTANT_Utf8_info
- CONSTANT_String_info

åè€…æ˜¯ String å¸¸é‡çš„ç±»å‹ï¼Œä½†å®ƒå¹¶ä¸ç›´æ¥æŒæœ‰ String å¸¸é‡çš„å†…å®¹ï¼Œè€Œæ˜¯åªæŒæœ‰ä¸€ä¸ªç¬¦å·å¼•ç”¨ï¼Œè¿™ä¸ªç¬¦å·å¼•ç”¨æ‰€æŒ‡å®šçš„å¦ä¸€ä¸ªå¸¸é‡æ± é¡¹å¿…é¡»æ˜¯ä¸€ä¸ª CONSTANT_Utf8_info ç±»å‹çš„å¸¸é‡ï¼Œè¿™é‡Œæ‰çœŸæ­£æŒæœ‰å­—ç¬¦ä¸²çš„å†…å®¹ï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
 #3 = String             #29            // abc
#29 = Utf8               abc
```

åœ¨ HotSpot è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼š

- CONSTANT_Utf8_info -> Symbol* (ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª Symbol ç±»å‹çš„ C++ å¯¹è±¡ï¼Œå†…å®¹æ˜¯è·Ÿ Class æ–‡ä»¶åŒæ ·æ ¼å¼çš„ UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²)
- CONSTANT_String_info -> java.lang.String (ä¸€ä¸ªå®é™…çš„ Java å¯¹è±¡çš„å¼•ç”¨)

CONSTANT_Utf8_info ä¼šåœ¨ç±»åŠ è½½çš„æ—¶å€™å°±è¢«å…¨éƒ¨åˆ›å»ºå‡ºæ¥ï¼Œè€Œ CONSTANT_String_info åˆ™æ˜¯ lazy resolve çš„ã€‚ä¾‹å¦‚ï¼šåœ¨å¼•ç”¨è¯¥é¡¹çš„ ldc æŒ‡ä»¤è¢«ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™æ‰ä¼š resolve

é‚£ä¹ˆåœ¨å°šæœª resolve çš„æ—¶å€™ï¼ŒHotSpot è™šæ‹ŸæœºæŠŠå®ƒçš„ç±»å‹å«åš JVM_CONSTANT_UnresolvedStringï¼Œå†…å®¹è·Ÿ Class æ–‡ä»¶é‡Œä¸€æ ·åªæ˜¯ä¸€ä¸ªç¬¦å·å¼•ç”¨

ç­‰åˆ° resolve è¿‡åè¿™ä¸ªé¡¹çš„å¸¸é‡ç±»å‹å°±ä¼šå˜æˆæœ€ç»ˆçš„ JVM_CONSTANT_Stringï¼Œè€Œå†…å®¹åˆ™å˜æˆå®é™…çš„å¼•ç”¨ (ç›´æ¥å¼•ç”¨)

ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ä¹Ÿæœ‰ä¸€æ®µè¯ä¸è°‹è€Œåˆï¼š**<font color='red'>è™šæ‹Ÿæœºå®ç°å¯ä»¥æ ¹æ®éœ€è¦æ¥è‡ªè¡Œåˆ¤æ–­ï¼Œåˆ°åº•æ˜¯åœ¨ç±»è¢«åŠ è½½å™¨åŠ è½½çš„æ—¶å€™å°±å¯¹å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è¿›è¡Œè§£æï¼Œè¿˜æ˜¯ç­‰åˆ°ä¸€ä¸ªç¬¦å·å¼•ç”¨å°†è¦è¢«ä½¿ç”¨å‰æ‰å»è§£æå®ƒ</font>**

æœ€åæ¥ä¸€æ³¢å°æ€»ç»“ï¼šå°± HotSpot è™šæ‹Ÿæœºçš„å®ç°æ¥è¯´ï¼Œåœ¨ç±»åŠ è½½çš„æ—¶å€™å­—ç¬¦ä¸²å­—é¢é‡ä¼šè¿›å…¥åˆ°å½“å‰ç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œä¸ä¼šè¿›å…¥å…¨å±€çš„å­—ç¬¦ä¸²å¸¸é‡æ±  (å³åœ¨ StringTable ä¸­å¹¶æ²¡æœ‰ç›¸åº”çš„å¼•ç”¨ï¼Œåœ¨å †ä¸­ä¹Ÿæ²¡æœ‰å¯¹åº”çš„å¯¹è±¡äº§ç”Ÿ)

#### <font color=#9933FF>ldc æŒ‡ä»¤</font>

ä¸‹é¢æ¥å¼ºè°ƒä¸€ä¸‹`ldc`æŒ‡ä»¤ï¼Œå®ƒçš„ä½œç”¨ï¼šå°†`int`ã€`float`æˆ–`String`å‹å¸¸é‡å€¼ä»å¸¸é‡æ± ä¸­æ¨é€è‡³æ ˆé¡¶

ä¸Šé¢å¼ºè°ƒè¿‡ï¼Œç±»åŠ è½½è¿‡ç¨‹ä¸­çš„è§£æé˜¶æ®µæ˜¯ lazy resolve (å»¶è¿Ÿ)ï¼Œé‚£åˆ°åº•ä¼šå»¶è¿Ÿåˆ°ä»€ä¹ˆæ—¶å€™æ‰ä¼šå»è§£æå‘¢ï¼Ÿï¼

**<font color='red'>æ‰§è¡Œ`ldc`æŒ‡ä»¤å°±æ˜¯è§¦å‘ lazy resolution åŠ¨ä½œçš„æ¡ä»¶</font>**

`ldc`å­—èŠ‚ç åœ¨è¿™é‡Œçš„æ‰§è¡Œè¯­ä¹‰æ˜¯ï¼šåˆ°å½“å‰ç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± å»æŸ¥æ‰¾è¯¥ç¬¦å·å¼•ç”¨å¯¹åº”çš„é¡¹ï¼Œå¦‚æœè¯¥é¡¹å°šæœª resolve åˆ™ resolveï¼Œå¹¶è¿”å› resolve åçš„å†…å®¹

åœ¨é‡åˆ°`String`ç±»å‹å¸¸é‡æ—¶ï¼Œresolve çš„è¿‡ç¨‹å¦‚æœå‘ç° StringTable å·²ç»æœ‰äº†å†…å®¹åŒ¹é…çš„`java.lang.String`çš„å¼•ç”¨ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªå¼•ç”¨

åä¹‹ï¼Œå¦‚æœ StringTable é‡Œå°šæœªæœ‰å†…å®¹åŒ¹é…çš„`String`å®ä¾‹çš„å¼•ç”¨ï¼Œåˆ™ä¼šåœ¨ Java å †é‡Œåˆ›å»ºä¸€ä¸ªå¯¹åº”å†…å®¹çš„`String`å¯¹è±¡ï¼Œç„¶ååœ¨ StringTable è®°å½•ä¸‹è¿™ä¸ªå¼•ç”¨ï¼Œå¹¶è¿”å›è¿™ä¸ªå¼•ç”¨

**<font color='red'>å¯è§ï¼Œ`ldc`æŒ‡ä»¤æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„`String`å®ä¾‹ï¼Œå…¨çœ‹åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œè¿™ä¸€æ¡`ldc`æŒ‡ä»¤æ—¶ï¼ŒStringTable æ˜¯å¦å·²ç»è®°å½•äº†ä¸€ä¸ªå¯¹åº”å†…å®¹çš„`String`çš„å¼•ç”¨</font>**

**å…³äºè¿™ä¸ªå†…å®¹çš„è¯¦ç»†è§£é‡Šå¯è§ [Java ä¸­new String("å­—é¢é‡") ä¸­ "å­—é¢é‡" æ˜¯ä½•æ—¶è¿›å…¥å­—ç¬¦ä¸²å¸¸é‡æ± çš„? - æœ¨å¥³å­©çš„å›ç­” - çŸ¥ä¹ ](https://www.zhihu.com/question/55994121/answer/147296098)**

### <font color=#1FA774>intern() æ–¹æ³•</font>

å°†ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡åŠ å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œåªæœ‰ä¸¤ç§æ–¹å¼ï¼š

- è‡ªåŠ¨åŠ å…¥ï¼šæ‰€æœ‰åŒå¼•å·`"xxx"`ä¸­çš„å†…å®¹éƒ½åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼ï¼
- æ‰‹åŠ¨åŠ å…¥ï¼šè°ƒç”¨`intern()`æ–¹æ³•

æ ¹æ®ã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€æ‰€åœ¨ä½ç½®çš„ä¸åŒï¼Œé‡Œé¢å­˜çš„å†…å®¹æœ‰äº›è®¸çš„ä¸åŒï¼ï¼

JDK6 åŠä¹‹å‰ï¼Œã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€åœ¨æ°¸ä¹…ä»£ä¸­ (éå †)ï¼Œè€Œå¯¹è±¡å´æ˜¯åœ¨å †ä¸­ï¼Œ**<font color='red'>æ‰€ä»¥ä¼šæŠŠé¦–æ¬¡é‡åˆ°çš„å­—ç¬¦ä¸²å®ä¾‹å¤åˆ¶åˆ°ã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€ä¸­å­˜å‚¨ï¼Œè¿”å›çš„ä¹Ÿæ˜¯æ°¸ä¹…ä»£é‡Œé¢è¿™ä¸ªå­—ç¬¦ä¸²å®ä¾‹çš„å¼•ç”¨</font>**

JDK7 åŠä¹‹åï¼Œã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€è¢«ç§»åˆ°äº†å †ä¸­ï¼Œè€Œå¯¹è±¡ä¹Ÿæ˜¯åœ¨å †ä¸­ï¼Œ**<font color='red'>æ‰€ä»¥å°±ä¸éœ€è¦å†æ‹·è´å­—ç¬¦ä¸²çš„å®ä¾‹åˆ°ã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€ï¼Œåªéœ€è¦åœ¨ã€Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€ä¸­è®°å½•ä¸€ä¸‹é¦–æ¬¡å‡ºç°çš„å®ä¾‹å¼•ç”¨å³å¯</font>**

```java
public class RuntimeConstantPoolOOM {
    public static void main(String[] args) throws InterruptedException {
        String str1 = new StringBuilder("è®¡ç®—æœº").append("è½¯ä»¶").toString();
        System.out.println(str1.intern() == str1);

        String str2 = new String("ja") + new String("va");
        System.out.println(str2.intern() == str2);
    }
}
```

è¿™é‡Œåˆ†ä¸‰ç§æƒ…å†µè®¨è®ºï¼Œåˆ†åˆ«åœ¨ JDK6ã€JDK7ã€JDK8 çš„ç‰ˆæœ¬ä¸‹ (æ˜¯ä¸æ˜¯å¾ˆéº»çƒ¦ï¼)

**JDK6**

- å­—ç¬¦ä¸²å¸¸é‡æ± åœ¨æ°¸ä¹…ä»£ï¼Œæ°¸ä¹…ä»£åœ¨æ–¹æ³•åŒºï¼Œå±äºéå †ä¸­
- `str1`å’Œ`str2`å¼•ç”¨çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨ Java å †ä¸­
- `str1.intern()`å’Œ`str2.intern()`è¿”å›çš„æ˜¯æ–¹æ³•åŒºä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„å®ä¾‹å¼•ç”¨
- æ‰€ä»¥ä¸¤ä¸ªéƒ½æ˜¯`false`

**JDK7**

- å­—ç¬¦ä¸²å¸¸é‡æ± ç§»åˆ°äº† Java å †ä¸­
- `str1.intern()`å’Œ`str2.intern()`è¿”å›çš„æ˜¯ Java å †ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„å®ä¾‹å¼•ç”¨
- ä½†ç”±äº`"java"`ä¼šåœ¨ä¸€å¼€å§‹å°±è¢«åŠ è½½åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œæ‰€ä»¥è°ƒç”¨`str2.intern()`æ–¹æ³•æ—¶å¹¶éé¦–æ¬¡é‡åˆ°ï¼Œè¿”å›çš„æ˜¯ä¸€å¼€å§‹å°±è¢«åŠ è½½åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å®ä¾‹å¼•ç”¨ï¼Œå’Œ`str2`æ˜¯ä¸åŒçš„
- æ‰€ä»¥ç¬¬ä¸€ä¸ªä¼šå¾—åˆ°`true`ï¼Œç¬¬äºŒä¸ªä¼šå¾—åˆ°`false`

**JDK8**

- å’Œ JDK7 åŸºæœ¬ä¸€æ ·ï¼Œä½†ä¸åŒåœ¨äº`"java"`ä¸€å¼€å§‹**ä¸ä¼š**è¢«åŠ è½½åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œæ‰€ä»¥è°ƒç”¨`str2.intern()`æ–¹æ³•æ—¶æ˜¯é¦–æ¬¡é‡åˆ°ï¼Œè¿”å›çš„å®ä¾‹å¼•ç”¨å’Œ`str2`ç›¸åŒ
- æ‰€ä»¥ä¸¤ä¸ªéƒ½æ˜¯`true`

è¿™é‡Œè¯¦ç»†è§£é‡Šä¸€ä¸‹`"java"`å­—ç¬¦ä¸²ä¸ºä»€ä¹ˆä¸€å¼€å§‹ä¼šè¢«åŠ è½½åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­

åœ¨`sun.misc.Version`ç±»ä¸­æœ‰ä¸€ä¸ªé™æ€å¸¸é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// JDK7
public class Version {
    // ...
    private static final String launcher_name = "java";
    // ...
}
```

HotSpot VM ä¼šåœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¸»åŠ¨è§¦å‘`java.lang.System`ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–ï¼Œè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨åˆ°`java.lang.System.initializeSystemClass()`é™æ€æ–¹æ³•ï¼š

```java
private static void initializeSystemClass() {
    // ...
    sun.misc.Version.init();
    // ...
}
```

æ‰€ä»¥`sun.misc.Version`ç±»ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œé™æ€å¸¸é‡ä¼šè¢«åŠ è½½åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼ï¼ä½†æ˜¯åœ¨ JDK8 çš„æ—¶å€™ï¼Œè¿™ä¸ªåœ°æ–¹æœ‰ç‚¹å˜åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// JDK8
public class Version {
	private static final String launcher_name = "openjdk";
}
```

**å…³äºè¿™ä¸ªå†…å®¹çš„è¯¦ç»†è§£é‡Šå¯è§ [å¦‚ä½•ç†è§£ã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœºã€‹ç¬¬äºŒç‰ˆä¸­å¯¹String.intern()æ–¹æ³•çš„è®²è§£ä¸­æ‰€ä¸¾çš„ä¾‹å­ï¼Ÿ - RednaxelaFXçš„å›ç­” - çŸ¥ä¹](https://www.zhihu.com/question/51102308/answer/124441115)**

å†æ¥ä¸€ä¸ªä¾‹å­ï¼š

```java
String str1 = new StringBuilder().append("è®¡ç®—æœºè½¯ä»¶").toString();
System.out.println(str1.intern() == str1);  // false
```

ä¸Šæ–‡å¼ºè°ƒè¿‡ã€Œæ‰€æœ‰åŒå¼•å·`"xxx"`ä¸­çš„å†…å®¹éƒ½åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼ï¼ã€æ‰€ä»¥`"è®¡ç®—æœºè½¯ä»¶"`åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œè°ƒç”¨`str2.intern()`æ–¹æ³•æ—¶å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»æœ‰äº†ï¼Œè¿”å›çš„å®ä¾‹å¼•ç”¨å’Œ`str1`æ˜¯ä¸åŒçš„

ä¸Šä¸ªä¾‹å­ä¸­`String str1 = new StringBuilder("è®¡ç®—æœº").append("è½¯ä»¶").toString()`ï¼Œ`"è®¡ç®—æœº"`å’Œ`"è½¯ä»¶"`éƒ½åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œä½†`"è®¡ç®—æœºè½¯ä»¶"`ä¸åœ¨ï¼ï¼

#### <font color=#9933FF>å¼ºè°ƒ</font>

å…ˆç»™å‡ºä¸€ä¸ªä¾‹å­ï¼š

```java
String s1 = new String("abc") + new String("def");  // ç¬¬ä¸€æ­¥
s1.intern();                                        // ç¬¬äºŒæ­¥
String s2 = "abcdef";                               // ç¬¬ä¸‰æ­¥
System.out.println(s1 == s2); // true
```

ç›¸ä¿¡æœ‰äº† **[å­—ç¬¦ä¸²å­—é¢é‡ä½•æ—¶è¿›å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Ÿï¼](./å­—ç¬¦ä¸²å¸¸é‡æ± .html#å­—ç¬¦ä¸²å­—é¢é‡ä½•æ—¶è¿›å…¥å­—ç¬¦ä¸²å¸¸é‡æ± )**çš„é“ºå«ï¼Œä¸éš¾ç†è§£è¾“å‡ºçš„ç»“æœï¼Œè¿™é‡Œå†å¼ºè°ƒä¸€ä¸‹ï¼ï¼

å½“æ‰§è¡Œåˆ°ã€Œç¬¬äºŒæ­¥ã€æ—¶ï¼Œæ­¤æ—¶å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å¹¶æ²¡æœ‰`"abcdef"`ï¼Œæ‰€ä»¥ä¼šæŠŠ`s1`åŠ å…¥åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­

å½“æ‰§è¡Œåˆ°ã€Œç¬¬ä¸‰æ­¥ã€æ—¶ï¼Œç”±äºå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»æœ‰äº†`"abcdef"`ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨`ldc`æŒ‡ä»¤ç»™`s2`èµ‹å€¼æ—¶ï¼Œç›´æ¥è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¼•ç”¨

æ‰€ä»¥`s1`å’Œ`s2`çš„å¼•ç”¨å€¼æ˜¯ç›¸åŒçš„ï¼ï¼ï¼

### <font color=#1FA774>å¯¹ String ä¸å¯å˜çš„ç†è§£</font>

#### <font color=#9933FF>ç†è§£ä¸€</font>

```java
String s = "abc";  // ç¬¬ä¸€æ­¥
s += "def";        // ç¬¬äºŒæ­¥
s += "ghi";        // ç¬¬ä¸‰æ­¥
```

é¦–å…ˆï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼š`"abc", "def", "ghi"`ã€‚å½“æ‰§è¡Œåˆ°æ¯ä¸€æ­¥æ—¶ï¼Œ`s`å¯¹åº”çš„å®ä¾‹å¼•ç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://cdn.jsdelivr.net/gh/LFool/image-hosting@master/20221120/0120251668878425MLJrlO11.svg" alt="11" style="zoom:90%;" />

è¿™é‡Œçš„`+=`å…¶å®æ˜¯ä¸€ç§å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå­—èŠ‚ç æŒ‡ä»¤å±‚é¢çš„åŸç†å’Œ **[å­—ç¬¦ä¸²å’Œå˜é‡çš„æ‹¼æ¥èµ‹å€¼](./å­—ç¬¦ä¸²å¸¸é‡æ± .html#å­—ç¬¦ä¸²å’Œå˜é‡çš„æ‹¼æ¥èµ‹å€¼)** ç›¸åŒï¼ï¼

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ‹¼æ¥çš„è¿‡ç¨‹ï¼Œå˜åŒ–çš„åªæœ‰`s`çš„å€¼ (å¼•ç”¨)ï¼Œå¯¹äºå­—ç¬¦ä¸²å¯¹è±¡æœ¬èº«æ¥è¯´å¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ¯æ¬¡éƒ½æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡

å€¼çš„æ³¨æ„çš„æ˜¯ï¼Œä¸Šå›¾ä¸­çš„**<font color='#6600CC'>ç´«è‰²ç®­å¤´</font>**æ˜¯ä¸å¯ä»¥å˜çš„ï¼Œå› ä¸º`String`ç±»ä¸­çš„`value`å­—æ®µè¢«`final`ä¿®é¥°ï¼Œæ‰€ä»¥å€¼ (å¼•ç”¨) ä¸å¯å˜ï¼Œæºç å¦‚ä¸‹ï¼š

```java
private final char value[];
```

#### <font color=#9933FF>ç†è§£äºŒ</font>

è‹¥åœ¨**ã€Œç†è§£ä¸€ã€**çš„åŸºç¡€ä¸Šç¨åŠ ä¿®æ”¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
final String s = "abc";
s += "def";   // é”™è¯¯ï¼Œç¼–è¯‘ä¸é€šè¿‡ âŒ
s += "ghi";   // é”™è¯¯ï¼Œç¼–è¯‘ä¸é€šè¿‡ âŒ
```

åŸç†å’Œ**ã€Œç†è§£ä¸€ã€**ä¸­ä¸€æ ·ï¼Œç”±äº`s`è¢«`final`ä¿®é¥°ï¼Œæ‰€ä»¥å€¼ (å¼•ç”¨) ä¸å¯å˜ï¼Œå¯¹åº”ä¸Šå›¾ä¸­å°±æ˜¯**<font color='red'>çº¢è‰²ç®­å¤´</font>**æ˜¯ä¸å¯ä»¥å˜çš„

#### <font color=#9933FF>ç†è§£ä¸‰</font>

ç»™å‡ºä¸€æ®µä»£ç ï¼Œæƒ³æƒ³ä¼šè¾“å‡ºä»€ä¹ˆï¼š

```java
public static void f1(String s) {
    s = "def";
}
public static void f2(char[] cs) {
    cs[0] = 'A';
}
public static void main(String[] args) {
    String s = "abc";
    char[] cs = new char[] {'a', 'b', 'c'};
    f1(s);
    f2(cs);
    System.out.println(s);    // abc
    System.out.println(cs);   // Abc
}
```

åœ¨å­¦ä¹  C è¯­è¨€çš„æ—¶å€™ï¼Œè‚¯å®šå¬è¿‡ã€Œä¼ å€¼ã€æˆ–ã€Œä¼ å¼•ç”¨ã€ï¼›Java ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„ä¸œè¥¿ï¼Œä½† Java ä¸­çš„æœ¬è´¨éƒ½æ˜¯ã€Œä¼ å€¼ã€

å¦‚æœå°†å˜é‡æŒ‰ç…§æ•°æ®ç±»å‹åˆ’åˆ†çš„è¯ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

- **åŸºæœ¬æ•°æ®ç±»å‹ï¼š**è®°å½•çš„æ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼
- **å¼•ç”¨æ•°æ®ç±»å‹ï¼š**è®°å½•çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨ (åœ°å€)ï¼Œå¯ä»¥é€šè¿‡è¯¥å¼•ç”¨æ‰¾åˆ°å¯¹è±¡

ä¹‹æ‰€ä»¥è¯´ Java ä¸­çš„æœ¬è´¨éƒ½æ˜¯ã€Œä¼ å€¼ã€ï¼Œå› ä¸ºå¦‚æœä¼ çš„æ˜¯ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹ï¼Œé‚£å°±æ˜¯å€¼ï¼›å¦‚æœä¼ çš„æ˜¯ä¸€ä¸ªå¼•ç”¨æ•°æ®ç±»å‹ï¼Œé‚£å°±æ˜¯å¼•ç”¨ï¼Œå…¶å®ä¹Ÿå°±æ˜¯è¯¥å˜é‡çš„å€¼

å›åˆ°ä¸Šé¢çš„ä»£ç ï¼Œå…ˆè§£é‡Š`s`ä¸ºä»€ä¹ˆæ²¡å˜ï¼Ÿï¼

- æˆ‘ä»¬åªæ˜¯æŠŠ`f1`ä¸­çš„å±€éƒ¨å˜é‡`s`çš„å¼•ç”¨æŒ‡å‘äº†å¦å¤–ä¸€ä¸ªå¯¹è±¡ (ç­‰ä»·äºä¿®æ”¹äº†ä¸Šå›¾ä¸­çš„**<font color='red'>çº¢è‰²ç®­å¤´</font>**)ï¼Œé‚£å…³`main`ä¸­çš„å±€éƒ¨å˜é‡`s`ä»€ä¹ˆäº‹æƒ…ï¼ï¼ï¼
- å› ä¸ºåªæ˜¯æŠŠ`main`ä¸­çš„å±€éƒ¨å˜é‡`s`çš„å€¼ä¼ ç»™äº†`f1`ï¼Œ`f1`ä¸­æ— è®ºæ€ä¹ˆä¿®æ”¹å®ƒï¼Œéƒ½ä¸ä¼šå½±å“`main`ä¸­çš„å±€éƒ¨å˜é‡`s`

å†è§£é‡Š`cs`ä¸ºä»€ä¹ˆå˜äº†ï¼Ÿï¼

- `cs[i] = 'x'`è¡¨ç¤ºæŠŠç›¸å¯¹èµ·å§‹åœ°å€åç§»é‡ä¸º`i`çš„åœ°å€çš„å€¼æ”¹ä¸º`'x'`
- å’Œä¸Šé¢çš„ä¸åŒç‚¹åœ¨äºæ­¤æ—¶æ˜¯æ ¹æ®åœ°å€ä¿®æ”¹äº†å€¼ï¼Œä¸Šé¢åªæ˜¯ä¿®æ”¹äº†å¼•ç”¨çš„å€¼

#### <font color=#9933FF>ç†è§£å››</font>

å‡è®¾`String`ç±»ä¸­`value`å­—æ®µä¸æ˜¯`private`ï¼Œå³å¯ä»¥ä»»æ„è®¿é—®ä¿®æ”¹ï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥è¯•è¯•ï¼ï¼

å¯ä»¥é€šè¿‡**åå°„æœºåˆ¶**è®¿é—®æˆ–ä¿®æ”¹æ— æƒé™çš„å­—æ®µï¼Œ**å…³äºæ“ä½œè¿è¡Œæ—¶ç±»çš„å†…éƒ¨å±æ€§åŠæ–¹æ³•çš„è¯¦ç»†å†…å®¹å¯è§ [åå°„æœºåˆ¶](åå°„æœºåˆ¶.html#æ“ä½œè¿è¡Œæ—¶ç±»çš„å†…éƒ¨å±æ€§åŠæ–¹æ³•)**

```java
public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
    String s = "abc";                                              // æµ‹è¯•å­—ç¬¦ä¸²å¯¹è±¡
    Class<String> stringClass = String.class;                      // è·å– String ç±»å‹å¯¹è±¡
    Field valueField = stringClass.getDeclaredField("value");      // è·å–ç±»å‹çš„ value å­—æ®µ
    valueField.setAccessible(true);                                // ç¦æ­¢è®¿é—®å®‰å…¨æ£€æŸ¥
    char[] value = (char[]) valueField.get(s);                     // è·å– s çš„ value å­—æ®µ
    value[0] = 'A';                                                // ä¿®æ”¹ç¬¬ 0 ä¸ªå­—ç¬¦
    System.out.println(s);                                         // è¾“å‡ºç»“æœä¸º Abc
}
```

ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡

### <font color=red>æœ¬ç¯‡æ–‡ç« å†…å®¹åå¤šï¼Œç‰¹æ„åšäº†ä¸€ä¸ªæ€ç»´å¯¼å›¾ï¼Œä¾¿äºæŠŠæ¡æ–‡ç« çš„è„‰ç»œï¼ï¼ğŸ˜</font>



<object data="https://cdn.jsdelivr.net/gh/LFool/image-hosting@master/20221124/2108421669295322YqUarT1707221669280842Kwvz3A1234.svg" type="image/svg+xml" ></object>

