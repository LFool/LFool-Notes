# 虚拟机栈面试题

本篇文章总结虚拟机栈的面试题！！

#### <font color=#9933FF>问题一：栈溢出的情况？</font>

《Java 虚拟机规范》中描述了两种异常：

- 如果线程请求的栈深度大于虚拟机所允许的最大深度，将抛出 **StackOverflowError (SOF)** 异常
- 如果虚拟机的栈内存允许动态扩展，当扩展栈容量无法申请到足够的内存时，将抛出 **OutOfMemoryError (OOM)** 异常

**<font color='red'>注意：</font>**栈容量只能由 -Xss 参数来设定

#### <font color=#9933FF>问题二：调整栈容量，就能保证不出现溢出吗？</font>

不能！！通过调整栈容量，可能会使原本出现溢出的代码不出现溢出了；但无法保证所有情况都不出现溢出！！

假设原本栈容量可以支持 5000 次调用，但代码有 6000 次调用，就会出现溢出；此时调整栈容量保证其可以支持 7000 次调用，那么原来的代码就不会出现溢出了

但如果另外一个代码有 8000 次调用，依旧会出现溢出！！

#### <font color=#9933FF>问题三：分配栈容量越大越好吗？</font>

不一定！！分配越大的栈容量，会压缩其他部分的大小，比如：堆，方法区等

#### <font color=#9933FF>问题四：垃圾回收是否会涉及到虚拟机栈？</font>

这里总结一下「运行时数据区域」的各个部分是否会发生 Error 或者 GC！!

|                 | Error |  GC  |
| :-------------: | :---: | :--: |
|     方法区      |   ✅   |  ✅   |
|       堆        |   ✅   |  ✅   |
|    虚拟机栈     |   ✅   |  ❌   |
|   本地方法栈    |   ✅   |  ❌   |
| 程序计数器 (PC) |   ❌   |  ❌   |

#### <font color=#9933FF>问题五：方法中定义的局部变量是否线程安全？</font>

需要分情况讨论，有的情况是线程安全，有的情况是线程不安全，会发生对象逃逸

```java
// 情况一：线程安全
// 对象 s1 随着方法调用的结束而消亡，不会被多个线程共享
public static void f1() {
    // 注意：StringBuilder 不是线程安全；StringBuffer 是线程安全
    StringBuilder s1 = new StringBuilder();
    s1.append("a");
    s1.append("b");
}

// 情况二：线程不安全
// 对象 s1 不会随着方法调用的结束而消亡，因为随着方法的返回值逃逸出去了，可能会被多个线程共享
public static StringBuilder f2() {
    StringBuilder s1 = new StringBuilder();
    s1.append("a");
    s1.append("b");
    return s1;
}

// 情况三：线程不安全
// 对象 s1 随着方法的参数传入方法中，不是线程私有，可能会被多个线程共享
public static void f3(StringBuilder s1) {
    s1.append("a");
    s1.append("b");
}

// 情况四：线程安全
// 对象 s1 随着方法调用的结束而消亡，不会被多个线程共享；而返回值是 String，它是不可变的
public static String f4() {
    StringBuilder s1 = new StringBuilder();
    s1.append("a");
    s1.append("b");
    return s1.toString();
}
```